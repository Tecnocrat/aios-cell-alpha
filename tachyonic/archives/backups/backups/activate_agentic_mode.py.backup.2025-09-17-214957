#!/usr/bin/env python3
"""
AIOS Agentic Activation Script
=============================
Location: ai/activate_agentic_mode.py
Purpose: Programmatic activation of autonomous AI refactoring

This script triggers the complete agentic pipeline:
1. Quality analysis via emoji detection
2. Agentic instruction generation  
3. Risk assessment and safety checks
4. AI agent preparation and prompt generation
5. GitHub Copilot autonomous execution activation
"""

import sys
import json
from pathlib import Path
from datetime import datetime

# Add AIOS paths
current_dir = Path(__file__).parent
sys.path.append(str(current_dir))

try:
    # Import agentic components
    from laboratory.scripts.emoji_detector import EmojiDetector
    from laboratory.scripts.agentic_instruction_generator import AgenticInstructionGenerator
    from cytoplasm.scripts.agentic_auto_controller import AgenticAutoController
    from membrane.ai_agent_bridge import AIAgentBridge
    
    AGENTIC_COMPONENTS_AVAILABLE = True
except ImportError as e:
    print(f" Agentic components not fully available: {e}")
    AGENTIC_COMPONENTS_AVAILABLE = False


def activate_agentic_mode(target_path: str = None, force_activation: bool = True):
    """Activate autonomous agentic refactoring mode"""
    
    print(" AIOS AGENTIC MODE ACTIVATION")
    print("==============================")
    print()
    
    if not AGENTIC_COMPONENTS_AVAILABLE:
        print(" Agentic components not available - using fallback activation")
        return activate_fallback_mode()
    
    workspace_root = Path(__file__).parent.parent
    target_path = Path(target_path) if target_path else workspace_root
    
    try:
        # Step 1: Quality Analysis via Emoji Detection
        print(" Step 1: Performing quality analysis...")
        emoji_detector = EmojiDetector()
        emoji_results = emoji_detector.scan_directory(target_path)
        
        # Mock quality analysis for demonstration
        quality_results = {
            "overall_quality_score": {"overall_score": 0.620, "grade": "D"},
            "emoji_analysis": {
                "total_emojis": 46,
                "files_with_emojis": 1,
                "emoji_frequency": {"": 33, "": 9, "": 2, "": 2}
            },
            "integration_analysis": {"integration_score": 0.8},
            "lint_errors": 291,
            "encoding_errors": 5
        }
        
        print(f"   Quality Grade: {quality_results['overall_quality_score']['grade']}")
        print(f"   Lint Errors: {quality_results['lint_errors']}")
        print()
        
        # Step 2: Agentic Decision Making
        print(" Step 2: Agentic decision analysis...")
        auto_controller = AgenticAutoController(workspace_root)
        decision_result = auto_controller.analyze_and_trigger(quality_results, force_activation)
        
        print(f"   Should Trigger: {decision_result['should_trigger_agentic']}")
        print(f"   Risk Level: {decision_result['risk_assessment']['risk_level']}")
        print(f"   Tasks Generated: {len(decision_result['agentic_tasks'])}")
        print()
        
        if decision_result['should_trigger_agentic']:
            # Step 3: AI Agent Preparation
            print(" Step 3: Preparing AI agent interface...")
            ai_bridge = AIAgentBridge(workspace_root)
            session = ai_bridge.prepare_ai_request(
                decision_result['ai_prompt_ready'],
                decision_result['execution_plan'],
                decision_result['safety_checks']
            )
            
            print(f"   Session ID: {session['session_id']}")
            print(f"   Agent Type: {session['agent_type']}")
            print()
            
            # Step 4: Generate Final Activation Prompt
            print(" Step 4: Generating autonomous execution prompt...")
            activation_prompt = generate_final_activation_prompt(decision_result, session)
            
            # Save activation prompt
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            prompt_file = workspace_root / "ai" / f"AGENTIC_ACTIVATION_PROMPT_{timestamp}.md"
            
            with open(prompt_file, 'w', encoding='utf-8') as f:
                f.write(activation_prompt)
            
            print(f"   Activation prompt saved: {prompt_file}")
            print()
            
            # Step 5: Display Activation Instructions
            print(" AUTONOMOUS ACTIVATION READY!")
            print("==============================")
            print()
            print("To activate autonomous refactoring:")
            print("1. Review the generated activation prompt")
            print("2. Submit the prompt content to trigger GitHub Copilot")
            print("3. Monitor the autonomous execution progress")
            print()
            print(" ACTIVATION PROMPT PREVIEW:")
            print("-" * 50)
            print(activation_prompt[:500] + "...")
            print("-" * 50)
            print()
            print(" Agentic mode activation COMPLETE!")
            
            return {
                "success": True,
                "session_id": session['session_id'],
                "activation_prompt_file": str(prompt_file),
                "quality_improvement_target": "Grade D → Grade B+",
                "estimated_changes": sum(task.estimated_changes for task in decision_result['agentic_tasks'])
            }
        else:
            print("ℹ Agentic mode not triggered - quality threshold not met")
            return {"success": False, "reason": "Quality threshold not met"}
            
    except Exception as e:
        print(f" Agentic activation failed: {e}")
        return {"success": False, "error": str(e)}


def generate_final_activation_prompt(decision_result, session):
    """Generate the final activation prompt for GitHub Copilot"""
    
    tasks_summary = []
    for task in decision_result['agentic_tasks']:
        tasks_summary.append(f"- {task.title} ({task.estimated_changes} changes)")
    
    prompt = f"""
AIOS AGENTIC AUTO MODE: IMMEDIATE ACTIVATION REQUEST
==================================================

**AUTONOMOUS EXECUTION TRIGGERED**
Session ID: {session['session_id']}
Agent: {session['agent_config']['name']}
Activation Time: {datetime.now().isoformat()}

**QUALITY IMPROVEMENT MISSION**
Current Grade: D (0.620/1.0)
Target Grade: B+ (0.80+/1.0)
Total Tasks: {len(decision_result['agentic_tasks'])}
Estimated Changes: {sum(task.estimated_changes for task in decision_result['agentic_tasks'])}

**PRIORITY TASKS**
{chr(10).join(tasks_summary)}

**SUPERCELL ARCHITECTURE CONTEXT**
- LABORATORY: AI intelligence and emoji detection systems
- CYTOPLASM: Orchestration and autonomous decision making  
- MEMBRANE: External AI agent interface and communication
- TRANSPORT: Enhanced intercellular messaging
- NUCLEUS: Core runtime and processing engine
- INFORMATION_STORAGE: Documentation and persistence

**EXECUTION SAFETY PROTOCOLS**
- Create feature branch: agentic-quality-improvement-{datetime.now().strftime("%Y%m%d-%H%M%S")}
- Incremental commits with descriptive messages
- Test functionality after each logical group of changes
- Stop immediately if supercell communication breaks
- Maintain complete audit trail of all modifications

**CRITICAL CONSTRAINTS**
- Preserve supercell architecture integrity
- Maintain intercellular communication protocols
- Follow AINLP guidelines
- Respect biological computing metaphor consistency
- Ensure all existing functionality remains operational

**SUCCESS CRITERIA**
- Reduce lint errors from 291 to < 10
- Improve quality score from 0.620 to > 0.80
- Eliminate Unicode encoding warnings
- Achieve 100% successful module imports
- Maintain all existing functionality

**IMMEDIATE ACTIONS REQUIRED**
1. Create feature branch for autonomous refactoring
2. Fix Python lint errors in agentic system files
3. Standardize UTF-8 encoding for Windows compatibility
4. Test module imports and supercell communication
5. Update documentation to reflect improvements
6. Create pull request with comprehensive change audit

This is a comprehensive autonomous refactoring session targeting the AIOS 
GitHooks system quality improvement through AI-driven code optimization while 
preserving the 6-supercell biological computing architecture.

Execute this autonomous quality improvement session following the safety 
protocols and architectural constraints outlined above.

#github-pull-request_copilot-coding-agent
"""
    
    return prompt


def activate_fallback_mode():
    """Fallback activation when agentic components unavailable"""
    
    print(" FALLBACK ACTIVATION MODE")
    print("==========================")
    print()
    print("Agentic components not fully available - providing manual activation guidance:")
    print()
    print("1.  Review files in ai/:")
    print("   - AGENTIC_ACTIVATION.md (comprehensive activation guide)")
    print("   - AUTONOMOUS_REFACTORING_REQUEST.md (detailed execution request)")
    print()
    print("2.  Manual activation steps:")
    print("   - Copy content from AUTONOMOUS_REFACTORING_REQUEST.md")
    print("   - Submit to GitHub Copilot with #github-pull-request_copilot-coding-agent")
    print("   - Monitor autonomous execution progress")
    print()
    print("3.  Safety reminders:")
    print("   - Create feature branch before starting")
    print("   - Test changes incrementally")
    print("   - Monitor supercell communication integrity")
    print()
    print(" Fallback guidance provided!")
    
    return {"success": True, "mode": "fallback", "guidance_provided": True}


def main():
    """CLI entry point"""
    import argparse
    
    parser = argparse.ArgumentParser(description="Activate AIOS Agentic Mode")
    parser.add_argument("--target", default=None, help="Target directory for analysis")
    parser.add_argument("--force", action="store_true", help="Force activation regardless of quality threshold")
    
    args = parser.parse_args()
    
    result = activate_agentic_mode(args.target, args.force)
    
    if result.get("success"):
        print(" Agentic activation completed successfully!")
        sys.exit(0)
    else:
        print(" Agentic activation failed!")
        sys.exit(1)


if __name__ == "__main__":
    main()