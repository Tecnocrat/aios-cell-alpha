#!/usr/bin/env python
#!/usr/bin/env python
"""Safety validation CLI.

Usage::
  python scripts/safety_validate.py --mode session
  python scripts/safety_validate.py --mode emergency
  python scripts/safety_validate.py --mode both

Exit codes:
  0 success
  2 safety violation (unauthorized allowed)
  3 emergency flag missing after trigger
"""

from __future__ import annotations

import argparse
import json
import sys
from pathlib import Path
from typing import Any, Dict

# Ensure project root is on sys.path when executed directly
PROJECT_ROOT = Path(__file__).resolve().parents[1]
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

from runtime_intelligence.tools import safety_demo  # noqa: E402


def main() -> int:
    ap = argparse.ArgumentParser()
    ap.add_argument(
        "--mode",
        choices=["session", "emergency", "both"],
        required=True,
        help="Validation mode to run",
    )
    ap.add_argument("--json", action="store_true", help="Emit JSON only")
    args = ap.parse_args()

    report: Dict[str, Any] = {}
    exit_code = 0

    if args.mode in ("session", "both"):
        session_rep = safety_demo.run_safety_session_demo(duration_minutes=1)
        report["session"] = session_rep
        if not session_rep["unauthorized_attempt"].get("blocked", False):
            exit_code = max(exit_code, 2)

    if args.mode in ("emergency", "both"):
        emer_rep = safety_demo.run_emergency_shutdown_demo()
        report["emergency"] = emer_rep
        if (
            emer_rep["session_started"]
            and not emer_rep["emergency_status"].get(
                "emergency_stopped", False
            )
        ):
            exit_code = max(exit_code, 3)

    if args.json:
        print(json.dumps(report))
    else:
        print(json.dumps(report, indent=2))

    return exit_code


if __name__ == "__main__":  # pragma: no cover
    sys.exit(main())
